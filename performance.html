<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analytics - My Trading Pal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e5e7eb;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: #1f2937;
            border-right: 1px solid #374151;
            padding: 24px;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .nav-section {
            margin-bottom: 32px;
            border-bottom: 1px solid rgba(55, 65, 81, 0.5);
            padding-bottom: 16px;
        }
        
        .nav-section:last-child {
            border-bottom: none;
        }

        .nav-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-left: 12px;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(55, 65, 81, 0.5);
            color: #ffffff;
        }

        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(55, 65, 81, 0.5);
            color: white;
            border: 1px solid #374151;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1f2937;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
        }

        .export-option {
            padding: 16px;
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid #374151;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
            margin-bottom: 12px;
        }

        .export-option:hover {
            background: rgba(55, 65, 81, 0.8);
            transform: translateX(4px);
        }

        .export-option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-option-desc {
            font-size: 12px;
            color: #9ca3af;
        }

        /* Performance Overview Cards */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .overview-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .overview-card:hover {
            transform: translateY(-2px);
        }

        .overview-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .overview-label {
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .overview-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .overview-change {
            font-size: 14px;
            font-weight: 500;
        }

        .positive { color: #10b981; }
        .negative { color: #ef4444; }

        /* Filter Controls */
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 12px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-label {
            color: #9ca3af;
            font-weight: 500;
        }

        .filter-select {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid #374151;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover {
            background: rgba(55, 65, 81, 0.8);
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-select option {
            background: #1f2937;
            color: white;
        }

        /* Date Input Styling */
        input[type="date"] {
            color-scheme: dark;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Chart Section */
        .chart-section {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative; /* For tooltip positioning */
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .chart-options {
            display: flex;
            gap: 12px;
            margin-left: 12px;
        }
        
        .axis-toggle-btn {
            padding: 6px 12px;
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid #374151;
            color: #9ca3af;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .axis-toggle-btn:hover {
            background: rgba(55, 65, 81, 0.5);
        }
        
        .axis-toggle-btn.active {
            background: rgba(55, 65, 81, 0.5);
            color: white;
            border-color: #667eea;
        }

        .time-selector {
            display: flex;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 8px;
            padding: 4px;
        }

        .time-btn {
            padding: 6px 12px;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .time-btn.active {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            border-color: #667eea;
        }

        #performanceChart {
            width: 100%;
            height: 440px;
            margin-top: 20px;
        }

        /* Tables */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .table-section {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #374151;
        }

        th {
            font-weight: 600;
            color: #9ca3af;
            font-size: 14px;
        }

        tr:hover {
            background: rgba(55, 65, 81, 0.2);
        }

        .strategy-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-morning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-nyopen {
            background: rgba(129, 140, 248, 0.2);
            color: #818cf8;
        }

        .badge-usorb {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
        }

        /* Risk Metrics */
        .risk-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
        }

        .metric-label {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-bar {
            height: 8px;
            background: rgba(55, 65, 81, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Chart Tooltip */
        #chartTooltip {
            position: absolute;
            display: none;
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid #374151;
            padding: 12px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        #tooltipDate {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }
        
        #tooltipValue {
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        #tooltipChange {
            font-size: 12px;
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-controls {
                flex-wrap: wrap;
            }
            
            .chart-options {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .overview-grid {
                grid-template-columns: 1fr;
            }
            
            .risk-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                flex-direction: column;
                gap: 12px;
            }
            
            .time-selector {
                flex-wrap: wrap;
            }
            
            .header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">My Trading Pal 🤖</div>
            
            <div class="nav-section">
                <div class="nav-section-title">MAIN</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <span class="nav-icon">📊</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="trades.html" class="nav-link">
                            <span class="nav-icon">💹</span>
                            Trade Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="accounts.html" class="nav-link">
                            <span class="nav-icon">💼</span>
                            Accounts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="strategies.html" class="nav-link">
                            <span class="nav-icon">📈</span>
                            Strategies
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">AI SYSTEM</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="ai-status.html" class="nav-link">
                            <span class="nav-icon">🤖</span>
                            AI Status
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="performance.html" class="nav-link active">
                            <span class="nav-icon">📊</span>
                            Performance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="risk-monitor.html" class="nav-link">
                            <span class="nav-icon">🛡️</span>
                            Risk Monitor
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">ANALYTICS</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link">
                            <span class="nav-icon">📑</span>
                            Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="logs.html" class="nav-link">
                            <span class="nav-icon">🔔</span>
                            System Logs
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">SETTINGS</div>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <span class="nav-icon">⚙️</span>
                            Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>📊 Performance Analytics</h1>
                <div class="header-controls">
                    <button class="btn btn-secondary" onclick="showExportModal()">
                        📄 Export Report
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        🔄 Refresh Data
                    </button>
                </div>
            </div>

            <!-- Export Modal -->
            <div id="exportModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><span style="font-size: 20px;">📊</span> Export Performance Data</h3>
                        <button class="close-modal" onclick="closeExportModal()">&times;</button>
                    </div>
                    
                    <div>
                        <button class="export-option" onclick="exportFormat('csv')">
                            <div class="export-option-title"><span style="font-size: 16px;">📄</span> CSV Format</div>
                            <div class="export-option-desc">Comma-separated values for Excel/Google Sheets</div>
                        </button>
                        
                        <button class="export-option" onclick="exportFormat('pdf')">
                            <div class="export-option-title"><span style="font-size: 16px;">📑</span> PDF Report</div>
                            <div class="export-option-desc">Formatted report with charts and summaries</div>
                        </button>
                        
                        <button class="export-option" onclick="exportFormat('excel')">
                            <div class="export-option-title"><span style="font-size: 16px;">📊</span> Excel Workbook</div>
                            <div class="export-option-desc">Multi-sheet workbook with analysis</div>
                        </button>
                        
                        <button class="export-option" onclick="exportFormat('json')">
                            <div class="export-option-title"><span style="font-size: 16px;">🔧</span> JSON Data</div>
                            <div class="export-option-desc">Raw data for API integration</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Custom Date Range Modal -->
            <div id="customDateModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3><span style="font-size: 20px;">📅</span> Custom Date Range</h3>
                        <button class="close-modal" onclick="closeCustomDateModal()">&times;</button>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: #9ca3af;">Start Date:</label>
                            <input type="date" id="startDate" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: white;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #9ca3af;">End Date:</label>
                            <input type="date" id="endDate" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: white;">
                        </div>
                        <button class="btn btn-primary" onclick="applyCustomDateRange()" style="width: 100%;">
                            Apply Date Range
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart Custom Date Range Modal -->
            <div id="chartCustomDateModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3><span style="font-size: 20px;">📅</span> Chart Custom Date Range</h3>
                        <button class="close-modal" onclick="closeChartDateModal()">&times;</button>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; color: #9ca3af;">Start Date:</label>
                            <input type="date" id="chartStartDate" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: white;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #9ca3af;">End Date:</label>
                            <input type="date" id="chartEndDate" style="width: 100%; padding: 8px 12px; background: rgba(55, 65, 81, 0.5); border: 1px solid #374151; border-radius: 8px; color: white;">
                        </div>
                        <button class="btn btn-primary" onclick="applyChartDateRange()" style="width: 100%;">
                            Apply to Chart
                        </button>
                    </div>
                </div>
            </div>

            <!-- Risk Explanation Modal -->
            <div id="riskExplanationModal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3><span style="font-size: 20px;">📊</span> Risk Metrics Explained</h3>
                        <button class="close-modal" onclick="closeRiskExplanationModal()">&times;</button>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <h4 style="margin-bottom: 12px; color: #10b981;">How Risk Metrics are Calculated:</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #e5e7eb; margin-bottom: 8px;">📉 Max Drawdown</h5>
                            <p style="color: #9ca3af; line-height: 1.6;">
                                The largest peak-to-trough decline in your total portfolio value. Calculated by tracking the highest portfolio value and measuring the percentage decline from that peak. Currently at -8.2% from the peak of $127,060.
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #e5e7eb; margin-bottom: 8px;">⚠️ Risk Level</h5>
                            <p style="color: #9ca3af; line-height: 1.6;">
                                A composite score based on:
                                <br>• Portfolio volatility (20-day standard deviation): 20%
                                <br>• Current drawdown severity: 15%
                                <br>• Position concentration: 10%
                                <br>• Win rate deviation from baseline: 0%
                                <br><strong>Total: 45% = Moderate Risk</strong>
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #e5e7eb; margin-bottom: 8px;">📊 Consecutive Losses</h5>
                            <p style="color: #9ca3af; line-height: 1.6;">
                                The current number of losing trades in a row across all accounts. Resets to 0 after a winning trade. Maximum tracked is 10 consecutive losses before risk controls activate.
                            </p>
                        </div>
                        
                        <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 8px;">
                            <p style="color: #10b981; font-weight: 600;">Note: All metrics are calculated for the total portfolio, not individual accounts.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Overview -->
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="overview-label">Total P&L</div>
                    <div class="overview-value positive" id="totalPnL">+$27,060</div>
                    <div class="overview-change positive">+27.1% all time</div>
                </div>
                <div class="overview-card">
                    <div class="overview-label">Win Rate</div>
                    <div class="overview-value" id="winRate">68.5%</div>
                    <div class="overview-change positive">+3.2% this month</div>
                </div>
                <div class="overview-card">
                    <div class="overview-label">Profit Factor</div>
                    <div class="overview-value" id="profitFactor">2.43</div>
                    <div class="overview-change positive">Above target (2.0)</div>
                </div>
                <div class="overview-card">
                    <div class="overview-label">Sharpe Ratio</div>
                    <div class="overview-value" id="sharpeRatio">1.82</div>
                    <div class="overview-change positive">Excellent risk-adjusted</div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filter-section">
                <div class="filter-group">
                    <span class="filter-label">Account:</span>
                    <select class="filter-select" id="accountFilter" onchange="filterData()">
                        <option value="all">All Accounts</option>
                        <option value="apex50k">Apex 50K</option>
                        <option value="tpt50k">TPT 50K</option>
                        <option value="test01">Test Acc 01</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Strategy:</span>
                    <select class="filter-select" id="strategyFilter" onchange="filterData()">
                        <option value="all">All Strategies</option>
                        <option value="morning">Morning Strategy</option>
                        <option value="nyopen">NY Open Strategy</option>
                        <option value="usorb">US ORB Strategy</option>
                    </select>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <h3 class="chart-title">Performance Over Time</h3>
                    <div class="chart-controls">
                        <div class="time-selector">
                            <button class="time-btn" onclick="updateChart('1D')">1D</button>
                            <button class="time-btn" onclick="updateChart('1W')">1W</button>
                            <button class="time-btn active" onclick="updateChart('1M')">1M</button>
                            <button class="time-btn" onclick="updateChart('3M')">3M</button>
                            <button class="time-btn" onclick="updateChart('YTD')">YTD</button>
                            <button class="time-btn" onclick="updateChart('ALL')">ALL</button>
                            <button class="time-btn" onclick="updateChart('Custom')">Custom</button>
                        </div>
                        <div class="chart-options">
                            <button class="axis-toggle-btn active" onclick="toggleAxisType('value')">$</button>
                            <button class="axis-toggle-btn" onclick="toggleAxisType('percent')">%</button>
                        </div>
                    </div>
                </div>
                <canvas id="performanceChart"></canvas>
                
                <!-- Chart Tooltip -->
                <div id="chartTooltip">
                    <div id="tooltipDate">Date</div>
                    <div id="tooltipValue">Value</div>
                    <div id="tooltipChange">Change</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <!-- Strategy Performance Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Strategy Performance</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="strategyTable">
                            <tr>
                                <td><span class="strategy-badge badge-morning">Morning</span></td>
                                <td>45</td>
                                <td class="positive">61.8%</td>
                                <td class="positive">+$8,250</td>
                                <td><span style="color: #10b981;">●</span> Active</td>
                            </tr>
                            <tr>
                                <td><span class="strategy-badge badge-nyopen">NY Open</span></td>
                                <td>52</td>
                                <td class="positive">56.3%</td>
                                <td class="positive">+$7,890</td>
                                <td><span style="color: #10b981;">●</span> Active</td>
                            </tr>
                            <tr>
                                <td><span class="strategy-badge badge-usorb">US ORB</span></td>
                                <td>38</td>
                                <td class="positive">71.1%</td>
                                <td class="positive">+$10,920</td>
                                <td><span style="color: #10b981;">●</span> Active</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Account Performance Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3 class="table-title">Account Performance</h3>
                        <div class="time-selector">
                            <button class="time-btn active" onclick="filterAccountTable('D')">D</button>
                            <button class="time-btn" onclick="filterAccountTable('W')">W</button>
                            <button class="time-btn" onclick="filterAccountTable('M')">M</button>
                            <button class="time-btn" onclick="filterAccountTable('Y')">Y</button>
                            <button class="time-btn" onclick="showCustomDateRange()">Custom</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Balance</th>
                                <th id="accountPeriodHeader">P&L Today</th>
                                <th>Monthly</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="accountTable">
                            <tr>
                                <td>Apex 50K</td>
                                <td>$52,450</td>
                                <td class="positive account-period-value">+$1,200</td>
                                <td class="positive">+$14,500</td>
                                <td><span style="color: #10b981;">●</span> Trading</td>
                            </tr>
                            <tr>
                                <td>TPT 50K</td>
                                <td>$54,820</td>
                                <td class="positive account-period-value">+$860</td>
                                <td class="positive">+$12,560</td>
                                <td><span style="color: #10b981;">●</span> Trading</td>
                            </tr>
                            <tr>
                                <td>Test Acc 01</td>
                                <td>$101,790</td>
                                <td class="positive account-period-value">+$0</td>
                                <td class="negative">-$220</td>
                                <td><span style="color: #f59e0b;">●</span> Paused</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="table-section">
                <div class="table-header">
                    <h3 class="table-title">Risk Metrics - Total Portfolio</h3>
                    <button class="btn btn-secondary" onclick="showRiskExplanation()" style="padding: 6px 12px; font-size: 14px;">
                        ℹ️ How is this calculated?
                    </button>
                </div>
                <div class="risk-metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value negative">-8.2%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 18%; background: #10b981;"></div>
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                            Peak to trough decline across all accounts
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Risk Level</div>
                        <div class="metric-value" style="color: #f59e0b;">Moderate</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 45%; background: #f59e0b;"></div>
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                            Based on volatility & position sizing
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Consecutive Losses</div>
                        <div class="metric-value">2</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 20%; background: #10b981;"></div>
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                            Current losing streak (max: 10)
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 16px; background: rgba(55, 65, 81, 0.3); border-radius: 8px; font-size: 14px; color: #9ca3af; line-height: 1.6;">
                    <strong style="color: #e5e7eb;">Risk Level Definition:</strong> Low (0-30%), Moderate (30-60%), High (60-80%), Critical (80-100%). 
                    <br>Currently at 45% due to: 15% drawdown weight + 20% volatility + 10% position concentration.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart Data
        let currentChartData = [];
        let currentTimeframe = '1M';
        let currentAccount = 'all';
        let currentStrategy = 'all';
        let accountDataCache = {}; // Cache for account data
        let currentAxisType = 'value'; // 'value' or 'percent'
        let hoveredDataPoint = null;
        let mouseX = 0;
        let mouseY = 0;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Performance Analytics loaded');
            initializeChart();
            
            // Initialize modal event listeners
            const modals = ['exportModal', 'customDateModal', 'riskExplanationModal', 'chartCustomDateModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.remove('active');
                        }
                    });
                }
            });
        });

        // Filter Data Function
        function filterData() {
            currentAccount = document.getElementById('accountFilter').value;
            currentStrategy = document.getElementById('strategyFilter').value;
            
            console.log(`Filtering data - Account: ${currentAccount}, Strategy: ${currentStrategy}`);
            
            // Regenerate chart data based on filters
            currentChartData = generateChartData(currentTimeframe);
            const canvas = document.getElementById('performanceChart');
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
            
            // Update metrics based on filters
            updateMetricsForFilters();
        }

        // Filter Account Table by Period
        function filterAccountTable(period) {
            // Update active button
            document.querySelectorAll('.table-section .time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update header and values
            const periodHeaders = {
                'D': 'P&L Today',
                'W': 'P&L This Week',
                'M': 'P&L This Month',
                'Y': 'P&L This Year'
            };
            
            const periodData = {
                'D': ['+$1,200', '+$860', '+$0'],
                'W': ['+$3,450', '+$2,890', '-$120'],
                'M': ['+$14,500', '+$12,560', '-$220'],
                'Y': ['+$45,200', '+$38,900', '+$1,790']
            };
            
            document.getElementById('accountPeriodHeader').textContent = periodHeaders[period];
            
            const values = document.querySelectorAll('.account-period-value');
            values.forEach((cell, index) => {
                const value = periodData[period][index];
                cell.textContent = value;
                cell.className = value.startsWith('+') ? 'positive account-period-value' : 'negative account-period-value';
            });
            
            console.log(`Account table filtered to: ${period}`);
        }

        // Update Metrics for Filters
        function updateMetricsForFilters() {
            // Simulate different metrics based on account/strategy filters
            const accountMultipliers = {
                'all': 1,
                'apex50k': 0.4,
                'tpt50k': 0.35,
                'test01': 0.25
            };
            
            const multiplier = accountMultipliers[currentAccount] || 1;
            const baseValue = 27060;
            const newValue = Math.round(baseValue * multiplier);
            
            document.getElementById('totalPnL').textContent = `+${newValue.toLocaleString()}`;
            
            // Update win rate based on strategy
            const strategyWinRates = {
                'all': '68.5%',
                'morning': '61.8%',
                'nyopen': '56.3%',
                'usorb': '71.1%'
            };
            
            document.getElementById('winRate').textContent = strategyWinRates[currentStrategy] || '68.5%';
        }

        // Export Modal Functions
        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
            console.log('Export modal opened');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
            console.log('Export modal closed');
        }

        // Export Format Handler
        function exportFormat(format) {
            console.log(`Exporting performance data as ${format}`);
            
            // Show loading state
            const originalText = event.target.innerHTML;
            event.target.innerHTML = '<div style="text-align: center;">⏳ Preparing export...</div>';
            event.target.disabled = true;
            
            setTimeout(() => {
                // Simulate export completion
                event.target.innerHTML = originalText;
                event.target.disabled = false;
                closeExportModal();
                
                // Show success notification
                showNotification(`Performance data exported as ${format.toUpperCase()}`, 'success');
                
                // In production, this would trigger actual file download
                console.log(`${format} file would be downloaded here`);
            }, 1500);
        }

        // Refresh Data
        function refreshData() {
            console.log('Refreshing performance data...');
            const btn = event.target;
            btn.innerHTML = '⏳ Refreshing...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '🔄 Refresh Data';
                btn.disabled = false;
                
                // Clear cache to get fresh data
                accountDataCache = {};
                
                // Update values with slight variations
                updateMetrics();
                
                // Regenerate and redraw chart
                currentChartData = generateChartData(currentTimeframe);
                redrawChart();
                
                showNotification('Performance data refreshed', 'success');
            }, 1000);
        }

        // Update Metrics
        function updateMetrics() {
            // Simulate data updates
            const totalPnL = document.getElementById('totalPnL');
            const currentValue = parseFloat(totalPnL.textContent.replace(/[^0-9.-]/g, ''));
            const change = (Math.random() - 0.3) * 1000;
            const newValue = currentValue + change;
            
            totalPnL.textContent = `${newValue >= 0 ? '+' : ''}${Math.abs(newValue).toLocaleString()}`;
            totalPnL.className = newValue >= 0 ? 'overview-value positive' : 'overview-value negative';
        }

        // Initialize Chart
        function initializeChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 440; // Increased to accommodate legend
            
            // Remove existing event listeners to prevent duplicates
            canvas.removeEventListener('mousemove', handleChartMouseMove);
            canvas.removeEventListener('mouseleave', handleChartMouseLeave);
            
            // Add mouse event listeners
            canvas.addEventListener('mousemove', handleChartMouseMove);
            canvas.addEventListener('mouseleave', handleChartMouseLeave);
            
            currentChartData = generateChartData('1M');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
        }
        
        // Handle mouse movement on chart
        function handleChartMouseMove(e) {
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            const leftPadding = 90;
            const rightPadding = 40;
            const topPadding = 40;
            const legendHeight = 40;
            const chartWidth = canvas.width - leftPadding - rightPadding;
            
            // Find closest data point
            const dataIndex = Math.round((mouseX - leftPadding) / chartWidth * (currentChartData.length - 1));
            
            if (dataIndex >= 0 && dataIndex < currentChartData.length && mouseX >= leftPadding && mouseX <= canvas.width - rightPadding) {
                const point = currentChartData[dataIndex];
                const startValue = currentChartData[0].y;
                
                hoveredDataPoint = {
                    index: dataIndex,
                    value: point.y,
                    date: point.date,
                    percentChange: ((point.y - startValue) / startValue) * 100
                };
                
                // Update tooltip
                const tooltip = document.getElementById('chartTooltip');
                const tooltipDate = document.getElementById('tooltipDate');
                const tooltipValue = document.getElementById('tooltipValue');
                const tooltipChange = document.getElementById('tooltipChange');
                
                // Format date
                const dateStr = point.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                tooltipDate.textContent = dateStr;
                
                // Format value based on axis type
                if (currentAxisType === 'percent') {
                    tooltipValue.textContent = `${hoveredDataPoint.percentChange >= 0 ? '+' : ''}${hoveredDataPoint.percentChange.toFixed(2)}%`;
                } else {
                    tooltipValue.textContent = `${hoveredDataPoint.value.toLocaleString()}`;
                }
                
                // Show change from start
                const change = hoveredDataPoint.value - startValue;
                const changePercent = hoveredDataPoint.percentChange;
                tooltipChange.textContent = `${change >= 0 ? '+' : ''}${Math.abs(change).toLocaleString()} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                
                // Position tooltip
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY - 40) + 'px';
            } else {
                hoveredDataPoint = null;
                document.getElementById('chartTooltip').style.display = 'none';
            }
            
            // Redraw chart
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
        }
        
        // Handle mouse leave on chart
        function handleChartMouseLeave() {
            hoveredDataPoint = null;
            document.getElementById('chartTooltip').style.display = 'none';
            
            const canvas = document.getElementById('performanceChart');
            canvas.style.cursor = 'default';
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
        }
        
        // Toggle axis type between value and percent
        function toggleAxisType(type) {
            currentAxisType = type;
            
            // Update button states
            document.querySelectorAll('.axis-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // Redraw chart
            const canvas = document.getElementById('performanceChart');
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
        }
        
        // Show chart custom date range modal
        function showChartDateRange() {
            document.getElementById('chartCustomDateModal').classList.add('active');
            
            // Set default dates
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('chartEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('chartStartDate').value = lastMonth.toISOString().split('T')[0];
        }
        
        // Close chart date modal
        function closeChartDateModal() {
            document.getElementById('chartCustomDateModal').classList.remove('active');
        }
        
        // Apply custom date range to chart
        function applyChartDateRange() {
            const startDate = document.getElementById('chartStartDate').value;
            const endDate = document.getElementById('chartEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Update button to show active state
            document.querySelectorAll('.chart-controls .time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the custom button and mark it active
            const customBtn = Array.from(document.querySelectorAll('.chart-controls .time-btn')).find(btn => btn.textContent === 'Custom');
            if (customBtn) {
                customBtn.classList.add('active');
            }
            
            // Generate custom date range data
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            currentTimeframe = 'CUSTOM';
            accountDataCache = {}; // Clear cache for new data
            
            // Generate new data for custom range
            currentChartData = generateCustomRangeData(days, start, end);
            
            // Redraw chart
            const canvas = document.getElementById('performanceChart');
            canvas.width = canvas.offsetWidth;
            canvas.height = 440;
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
            
            closeChartDateModal();
            console.log(`Custom chart range applied: ${startDate} to ${endDate}`);
        }
        
        // Generate data for custom date range
        function generateCustomRangeData(days, startDate, endDate) {
            const data = [];
            
            if (currentAccount === 'all') {
                // For all accounts, sum up individual data
                const apexData = generateAccountCustomData(days, 'apex50k');
                const tptData = generateAccountCustomData(days, 'tpt50k');
                const testData = generateAccountCustomData(days, 'test01');
                
                for (let i = 0; i < days; i++) {
                    const totalValue = apexData[i] + tptData[i] + testData[i];
                    const currentDate = new Date(startDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    
                    data.push({
                        x: i,
                        y: totalValue,
                        date: currentDate
                    });
                }
            } else {
                // For individual account
                const accountStartValues = {
                    'apex50k': 50000,
                    'tpt50k': 50000,
                    'test01': 100000
                };
                
                let value = accountStartValues[currentAccount] || 100000;
                
                for (let i = 0; i < days; i++) {
                    value += (Math.random() - 0.3) * 2000 * 0.3;
                    const currentDate = new Date(startDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    
                    data.push({
                        x: i,
                        y: value,
                        date: currentDate
                    });
                }
            }
            
            return data;
        }
        
        // Generate custom data for individual account
        function generateAccountCustomData(days, account) {
            const accountStartValues = {
                'apex50k': 50000,
                'tpt50k': 50000,
                'test01': 100000
            };
            
            let value = accountStartValues[account] || 50000;
            const data = [];
            
            for (let i = 0; i < days; i++) {
                value += (Math.random() - 0.3) * 1000 * 0.8;
                data.push(value);
            }
            
            return data;
        }

        // Generate Chart Data
        function generateChartData(period) {
            const dataPoints = {
                '1D': 24,
                '1W': 7,
                '1M': 30,
                '3M': 90,
                'YTD': 200,
                'ALL': 365
            };
            
            const points = dataPoints[period] || 30;
            const data = [];
            
            if (currentAccount === 'all') {
                // For "all accounts", sum up individual account data
                const apexData = generateAccountData(period, 'apex50k');
                const tptData = generateAccountData(period, 'tpt50k');
                const testData = generateAccountData(period, 'test01');
                
                for (let i = 0; i < points; i++) {
                    const totalValue = apexData[i].y + tptData[i].y + testData[i].y;
                    data.push({
                        x: i,
                        y: totalValue,
                        date: apexData[i].date // Use date from first account
                    });
                }
            } else {
                // For individual accounts
                const accountStartValues = {
                    'apex50k': 50000,
                    'tpt50k': 50000,
                    'test01': 100000
                };
                
                let value = accountStartValues[currentAccount] || 100000;
                
                // Different volatility based on strategy
                const strategyVolatility = {
                    'all': 0.3,
                    'morning': 0.25,
                    'nyopen': 0.35,
                    'usorb': 0.2
                };
                
                const volatility = strategyVolatility[currentStrategy] || 0.3;
                
                for (let i = 0; i < points; i++) {
                    value += (Math.random() - 0.3) * 2000 * volatility;
                    data.push({
                        x: i,
                        y: value,
                        date: new Date(Date.now() - (points - i) * 24 * 60 * 60 * 1000)
                    });
                }
            }
            
            return data;
        }

        // Draw Performance Chart
        function drawPerformanceChart(ctx, width, height) {
            ctx.clearRect(0, 0, width, height);
            
            if (currentChartData.length === 0) return;
            
            const leftPadding = 90; // Increased for Y-axis labels and title
            const rightPadding = 40;
            const topPadding = 40;
            const legendHeight = 40;
            const chartWidth = width - leftPadding - rightPadding;
            const chartHeight = height - topPadding - legendHeight;
            
            // Calculate global min/max for consistent scaling
            let globalMin = Math.min(...currentChartData.map(d => d.y));
            let globalMax = Math.max(...currentChartData.map(d => d.y));
            
            // If "all accounts" is selected, include individual account data in scale calculation
            if (currentAccount === 'all') {
                const accounts = ['apex50k', 'tpt50k', 'test01'];
                accounts.forEach(account => {
                    const accountData = generateAccountData(currentTimeframe, account);
                    const accountMin = Math.min(...accountData.map(d => d.y));
                    const accountMax = Math.max(...accountData.map(d => d.y));
                    globalMin = Math.min(globalMin, accountMin);
                    globalMax = Math.max(globalMax, accountMax);
                });
            }
            
            const globalRange = globalMax - globalMin;
            const startValue = currentChartData[0].y;
            
            // Draw Y-axis labels
            ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 5; i++) {
                const y = topPadding + (chartHeight / 5) * i;
                const value = globalMax - (globalRange / 5) * i;
                
                let label;
                if (currentAxisType === 'percent') {
                    const percentChange = ((value - startValue) / startValue) * 100;
                    label = `${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(1)}%`;
                } else {
                    label = `${(value / 1000).toFixed(0)}k`;
                }
                
                ctx.fillText(label, leftPadding - 10, y + 4);
                
                // Draw grid lines
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(leftPadding, y);
                ctx.lineTo(width - rightPadding, y);
                ctx.stroke();
            }
            
            ctx.textAlign = 'left';
            
            // If "all accounts" is selected, draw individual account lines
            if (currentAccount === 'all') {
                const accounts = ['apex50k', 'tpt50k', 'test01'];
                const accountColors = {
                    'apex50k': '#f59e0b',
                    'tpt50k': '#3b82f6',
                    'test01': '#a78bfa'
                };
                
                // Draw individual account lines (semi-transparent and dashed)
                ctx.globalAlpha = 0.5;
                accounts.forEach(account => {
                    const accountData = generateAccountData(currentTimeframe, account);
                    
                    ctx.strokeStyle = accountColors[account];
                    ctx.lineWidth = 2;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    
                    accountData.forEach((point, index) => {
                        const x = leftPadding + (chartWidth / (accountData.length - 1)) * index;
                        const y = topPadding + chartHeight - ((point.y - globalMin) / globalRange) * chartHeight;
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.stroke();
                });
                ctx.setLineDash([]);
                ctx.globalAlpha = 1;
            }
            
            // Draw area fill for main line
            ctx.fillStyle = 'rgba(16, 185, 129, 0.15)';
            ctx.beginPath();
            
            currentChartData.forEach((point, index) => {
                const x = leftPadding + (chartWidth / (currentChartData.length - 1)) * index;
                const y = topPadding + chartHeight - ((point.y - globalMin) / globalRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.lineTo(width - rightPadding, topPadding + chartHeight);
            ctx.lineTo(leftPadding, topPadding + chartHeight);
            ctx.closePath();
            ctx.fill();
            
            // Draw main chart line
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            currentChartData.forEach((point, index) => {
                const x = leftPadding + (chartWidth / (currentChartData.length - 1)) * index;
                const y = topPadding + chartHeight - ((point.y - globalMin) / globalRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw data points on main line
            ctx.fillStyle = '#10b981';
            currentChartData.forEach((point, index) => {
                if (index % Math.floor(currentChartData.length / 10) === 0) {
                    const x = leftPadding + (chartWidth / (currentChartData.length - 1)) * index;
                    const y = topPadding + chartHeight - ((point.y - globalMin) / globalRange) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Draw hover point if exists
            if (hoveredDataPoint) {
                const x = leftPadding + (chartWidth / (currentChartData.length - 1)) * hoveredDataPoint.index;
                const y = topPadding + chartHeight - ((hoveredDataPoint.value - globalMin) / globalRange) * chartHeight;
                
                // Draw vertical line
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, topPadding);
                ctx.lineTo(x, topPadding + chartHeight);
                ctx.stroke();
                
                // Draw highlight circle
                ctx.fillStyle = '#10b981';
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }
            
            // Draw legend at bottom if showing all accounts
            if (currentAccount === 'all') {
                const legendY = height - legendHeight + 10;
                const legendItems = [
                    { name: 'All Accounts', color: '#10b981', solid: true, shaded: true },
                    { name: 'Apex 50K', color: '#f59e0b', dashed: true, opacity: 0.5 },
                    { name: 'TPT 50K', color: '#3b82f6', dashed: true, opacity: 0.5 },
                    { name: 'Test Acc 01', color: '#a78bfa', dashed: true, opacity: 0.5 }
                ];
                
                const totalWidth = legendItems.length * 140;
                let startX = (width - totalWidth) / 2;
                
                ctx.font = '12px -apple-system, BlinkMacSystemFont, sans-serif';
                
                legendItems.forEach((item, index) => {
                    const x = startX + (index * 140);
                    
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = item.solid ? 3 : 2;
                    ctx.globalAlpha = item.opacity || 1;
                    if (item.dashed) ctx.setLineDash([5, 3]);
                    
                    ctx.beginPath();
                    ctx.moveTo(x, legendY);
                    ctx.lineTo(x + 20, legendY);
                    ctx.stroke();
                    
                    ctx.setLineDash([]);
                    ctx.globalAlpha = 1;
                    
                    if (item.shaded) {
                        ctx.fillStyle = item.color;
                        ctx.globalAlpha = 0.15;
                        ctx.fillRect(x, legendY - 5, 20, 10);
                        ctx.globalAlpha = 1;
                    }
                    
                    ctx.fillStyle = '#e5e7eb';
                    ctx.fillText(item.name, x + 25, legendY + 4);
                });
            }
        }
        
        // Generate data for individual accounts
        function generateAccountData(period, account) {
            // Handle custom timeframe
            if (period === 'CUSTOM' && currentTimeframe === 'CUSTOM') {
                // Return cached custom data if available
                const cacheKey = `${account}-CUSTOM`;
                if (accountDataCache[cacheKey]) {
                    return accountDataCache[cacheKey];
                }
                
                // Generate custom data
                const customData = [];
                const accountStartValues = {
                    'apex50k': 50000,
                    'tpt50k': 50000,
                    'test01': 100000
                };
                
                let value = accountStartValues[account] || 50000;
                const days = currentChartData.length; // Use same length as main data
                
                for (let i = 0; i < days; i++) {
                    value += (Math.random() - 0.3) * 1000 * 0.8;
                    customData.push({
                        x: i,
                        y: value,
                        date: currentChartData[i].date // Use same dates as main data
                    });
                }
                
                accountDataCache[cacheKey] = customData;
                return customData;
            }
            
            // Check cache first for normal timeframes
            const cacheKey = `${account}-${period}`;
            if (accountDataCache[cacheKey]) {
                return accountDataCache[cacheKey];
            }
            
            const dataPoints = {
                '1D': 24,
                '1W': 7,
                '1M': 30,
                '3M': 90,
                'YTD': 200,
                'ALL': 365
            };
            
            const points = dataPoints[period] || 30;
            const data = [];
            
            const accountStartValues = {
                'apex50k': 50000,
                'tpt50k': 50000,
                'test01': 100000
            };
            
            let value = accountStartValues[account] || 50000;
            
            // Different volatility for each account
            const accountVolatility = {
                'apex50k': 0.8,
                'tpt50k': 0.9,
                'test01': 0.6
            };
            
            const volatility = accountVolatility[account] || 0.8;
            
            for (let i = 0; i < points; i++) {
                value += (Math.random() - 0.3) * 1000 * volatility;
                data.push({
                    x: i,
                    y: value,
                    date: new Date(Date.now() - (points - i) * 24 * 60 * 60 * 1000)
                });
            }
            
            // Cache the data
            accountDataCache[cacheKey] = data;
            
            return data;
        }

        // Update Chart
        function updateChart(period) {
            // Only update time buttons in the chart controls
            document.querySelectorAll('.chart-controls .time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentTimeframe = period;
            currentChartData = generateChartData(period);
            
            const canvas = document.getElementById('performanceChart');
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            drawPerformanceChart(ctx, canvas.width, canvas.height);
            
            updateMetricsForTimeframe(period);
            
            console.log(`Chart updated to ${period} view`);
        }

        // Update Metrics for Timeframe
        function updateMetricsForTimeframe(timeframe) {
            const metrics = {
                '1D': { pnl: '+$2,060', change: '+1.4% today', winRate: '80%' },
                '1W': { pnl: '+$5,840', change: '+4.2% this week', winRate: '72%' },
                '1M': { pnl: '+$27,060', change: '+27.1% this month', winRate: '68.5%' },
                '3M': { pnl: '+$52,000', change: '+52% (3 months)', winRate: '66%' },
                'YTD': { pnl: '+$85,000', change: '+85% YTD', winRate: '67%' },
                'ALL': { pnl: '+$127,060', change: '+127% all time', winRate: '68%' },
                'CUSTOM': { pnl: '+$15,230', change: '+15.2% (custom period)', winRate: '65%' }
            };
            
            const data = metrics[timeframe] || metrics['1M'];
            document.getElementById('totalPnL').textContent = data.pnl;
            document.getElementById('winRate').textContent = data.winRate;
            document.querySelector('.overview-card:first-child .overview-change').textContent = data.change;
        }

        // Redraw Chart on Resize
        function redrawChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 440; // Increased to accommodate legend
            drawPerformanceChart(ctx, canvas.width, canvas.height);
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#667eea'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 1001;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                redrawChart();
            }, 250);
        });

        // Show Custom Date Range Modal
        function showCustomDateRange() {
            document.getElementById('customDateModal').classList.add('active');
            
            // Set default dates
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = lastMonth.toISOString().split('T')[0];
        }
        
        // Close Custom Date Modal
        function closeCustomDateModal() {
            document.getElementById('customDateModal').classList.remove('active');
        }
        
        // Apply Custom Date Range
        function applyCustomDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Update button text to show custom range
            document.querySelectorAll('.table-section .time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find the custom button and mark it active
            const customBtn = Array.from(document.querySelectorAll('.table-section .time-btn')).find(btn => btn.textContent === 'Custom');
            if (customBtn) {
                customBtn.classList.add('active');
            }
            
            // Update header
            document.getElementById('accountPeriodHeader').textContent = `P&L (${startDate} to ${endDate})`;
            
            // Update values with custom range data
            const values = document.querySelectorAll('.account-period-value');
            values.forEach((cell, index) => {
                // Simulate custom range values
                const customValues = ['+$8,920', '+$7,340', '+$450'];
                cell.textContent = customValues[index];
                cell.className = customValues[index].startsWith('+') ? 'positive account-period-value' : 'negative account-period-value';
            });
            
            closeCustomDateModal();
            console.log(`Custom date range applied: ${startDate} to ${endDate}`);
        }
        
        // Show Risk Explanation Modal
        function showRiskExplanation() {
            document.getElementById('riskExplanationModal').classList.add('active');
        }
        
        // Close Risk Explanation Modal
        function closeRiskExplanationModal() {
            document.getElementById('riskExplanationModal').classList.remove('active');
        }
    </script>
</body>
</html>